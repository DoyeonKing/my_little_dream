package com.example.thearter_platform.ui.screens

import androidx.compose.foundation.layout.*
import androidx.compose.foundation.lazy.LazyColumn
import androidx.compose.foundation.lazy.LazyRow
import androidx.compose.foundation.lazy.items
import androidx.compose.material.icons.Icons
import androidx.compose.material.icons.filled.ArrowBack
import androidx.compose.material.icons.filled.Add
import androidx.compose.material.icons.filled.Info
import androidx.compose.material.icons.filled.Search
import androidx.compose.material3.*
import androidx.compose.runtime.*
import androidx.compose.ui.Alignment
import androidx.compose.ui.Modifier
import androidx.compose.ui.text.font.FontWeight
import androidx.compose.ui.unit.dp
import androidx.compose.ui.unit.sp
import androidx.navigation.NavController
import androidx.compose.foundation.clickable
import androidx.compose.foundation.background
import androidx.compose.foundation.shape.RoundedCornerShape
import androidx.compose.ui.draw.clip
import androidx.compose.ui.graphics.Color
import com.example.thearter_platform.ui.models.TicketPost
import com.example.thearter_platform.ui.utils.getTypeColor
import com.example.thearter_platform.ui.utils.getTypeText
import com.example.thearter_platform.ui.utils.getTicketPosts

@OptIn(ExperimentalMaterial3Api::class)
@Composable
fun TicketExchangeScreen(navController: NavController) {
    var selectedFilter by remember { mutableStateOf("ÂÖ®ÈÉ®") }
    var searchQuery by remember { mutableStateOf("") }
    val filters = listOf("ÂÖ®ÈÉ®", "ËΩ¨ËÆ©", "Ê±ÇË¥≠", "‰∫§Êç¢")
    
    Scaffold(
        topBar = {
            TopAppBar(
                title = { Text("üé≠ ÁõòÁ•®Á§æÂå∫") },
                navigationIcon = {
                    IconButton(onClick = { navController.navigateUp() }) {
                        Icon(Icons.Filled.ArrowBack, contentDescription = "ËøîÂõû")
                    }
                },
                actions = {
                    IconButton(onClick = { /* ÊêúÁ¥¢ÂäüËÉΩ */ }) {
                        Icon(Icons.Filled.Search, contentDescription = "ÊêúÁ¥¢")
                    }
                    IconButton(onClick = { /* Á≠õÈÄâÂäüËÉΩ */ }) {
                        Icon(Icons.Filled.Info, contentDescription = "Á≠õÈÄâ")
                    }
                }
            )
        },
        floatingActionButton = {
            FloatingActionButton(
                onClick = { navController.navigate("create-ticket-post") },
                containerColor = MaterialTheme.colorScheme.primary
            ) {
                Icon(Icons.Filled.Add, contentDescription = "ÂèëÂ∏ÉÁ•®Âä°")
            }
        }
    ) { padding ->
        Column(
            modifier = Modifier
                .fillMaxSize()
                .padding(padding)
        ) {
            // Á≠õÈÄâÊ†áÁ≠æ
            LazyRow(
                modifier = Modifier.padding(horizontal = 16.dp, vertical = 8.dp),
                horizontalArrangement = Arrangement.spacedBy(8.dp)
            ) {
                items(filters) { filter ->
                    FilterChip(
                        selected = selectedFilter == filter,
                        onClick = { selectedFilter = filter },
                        label = { Text(filter) },
                        colors = FilterChipDefaults.filterChipColors(
                            selectedContainerColor = MaterialTheme.colorScheme.primary,
                            selectedLabelColor = MaterialTheme.colorScheme.onPrimary
                        )
                    )
                }
            }
            
            // Á•®Âä°ÂàóË°®
            LazyColumn(
                modifier = Modifier.fillMaxSize(),
                contentPadding = PaddingValues(16.dp),
                verticalArrangement = Arrangement.spacedBy(12.dp)
            ) {
                items(getTicketPosts(selectedFilter)) { post ->
                    TicketPostCard(
                        post = post,
                        onClick = { navController.navigate("ticket-detail/${post.id}") }
                    )
                }
            }
        }
    }
}

@Composable
fun TicketPostCard(
    post: TicketPost,
    onClick: () -> Unit
) {
    Card(
        modifier = Modifier
            .fillMaxWidth()
            .clickable { onClick() },
        elevation = CardDefaults.cardElevation(defaultElevation = 4.dp)
    ) {
        Column(
            modifier = Modifier.padding(16.dp)
        ) {
            // Â§¥ÈÉ®‰ø°ÊÅØ
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Box(
                        modifier = Modifier
                            .size(40.dp)
                            .clip(RoundedCornerShape(20.dp))
                            .background(getTypeColor(post.type)),
                        contentAlignment = Alignment.Center
                    ) {
                        Text(
                            text = getTypeText(post.type).first().toString(),
                            fontSize = 16.sp,
                            fontWeight = FontWeight.Bold,
                            color = Color.White
                        )
                    }
                    Spacer(modifier = Modifier.width(12.dp))
                    Column {
                        Text(
                            text = post.userName,
                            fontSize = 14.sp,
                            fontWeight = FontWeight.Medium
                        )
                        Text(
                            text = post.postTime,
                            fontSize = 12.sp,
                            color = MaterialTheme.colorScheme.onSurfaceVariant
                        )
                    }
                }
                
                Box(
                    modifier = Modifier
                        .clip(RoundedCornerShape(12.dp))
                        .background(getTypeColor(post.type).copy(alpha = 0.1f))
                        .padding(horizontal = 8.dp, vertical = 4.dp)
                ) {
                    Text(
                        text = getTypeText(post.type),
                        fontSize = 12.sp,
                        color = getTypeColor(post.type),
                        fontWeight = FontWeight.Medium
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            // Á•®Âä°‰ø°ÊÅØ
            Text(
                text = post.title,
                fontSize = 16.sp,
                fontWeight = FontWeight.Bold
            )
            
            Spacer(modifier = Modifier.height(8.dp))
            
            Text(
                text = post.description,
                fontSize = 14.sp,
                color = MaterialTheme.colorScheme.onSurfaceVariant,
                maxLines = 2
            )
            
            Spacer(modifier = Modifier.height(12.dp))
            
            // Á•®Âä°ËØ¶ÊÉÖ
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween
            ) {
                Column {
                    Text(
                        text = "ÊºîÂá∫Ôºö${post.performanceName}",
                        fontSize = 14.sp,
                        fontWeight = FontWeight.Medium
                    )
                    Text(
                        text = "Êó∂Èó¥Ôºö${post.performanceTime}",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Text(
                        text = "Âú∞ÁÇπÔºö${post.performanceVenue}",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                Column(
                    horizontalAlignment = Alignment.End
                ) {
                    Text(
                        text = "¬•${post.price}",
                        fontSize = 18.sp,
                        fontWeight = FontWeight.Bold,
                        color = MaterialTheme.colorScheme.primary
                    )
                    Text(
                        text = "${post.quantity}Âº†",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
            }
            
            Spacer(modifier = Modifier.height(12.dp))
            
            // Â∫ïÈÉ®Êìç‰Ωú
            Row(
                modifier = Modifier.fillMaxWidth(),
                horizontalArrangement = Arrangement.SpaceBetween,
                verticalAlignment = Alignment.CenterVertically
            ) {
                Row(
                    verticalAlignment = Alignment.CenterVertically
                ) {
                    Text(
                        text = "üí¨ ${post.commentCount}",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                    Spacer(modifier = Modifier.width(16.dp))
                    Text(
                        text = "üëÅÔ∏è ${post.viewCount}",
                        fontSize = 12.sp,
                        color = MaterialTheme.colorScheme.onSurfaceVariant
                    )
                }
                
                Button(
                    onClick = { /* ËÅîÁ≥ªÁî®Êà∑ */ },
                    colors = ButtonDefaults.buttonColors(
                        containerColor = getTypeColor(post.type)
                    )
                ) {
                    Text(
                        text = when (post.type) {
                            "transfer" -> "ËÅîÁ≥ªËΩ¨ËÆ©"
                            "purchase" -> "ËÅîÁ≥ªÊ±ÇË¥≠"
                            "exchange" -> "ËÅîÁ≥ª‰∫§Êç¢"
                            else -> "ËÅîÁ≥ª"
                        }
                    )
                }
            }
        }
    }
}

// Ê®°ÊãüÊï∞ÊçÆ

// Ê®°ÊãüÊï∞ÊçÆ
fun getTicketPosts(filter: String): List<TicketPost> {
    val allPosts = listOf(
        TicketPost(
            id = "1",
            type = "transfer",
            userName = "ÂâßÂú∫Áà±Â•ΩËÄÖ",
            postTime = "2Â∞èÊó∂Ââç",
            title = "ËΩ¨ËÆ©„ÄäÂìàÂßÜÈõ∑Áâπ„ÄãÊºîÂá∫Á•®",
            description = "Âõ†‰∏¥Êó∂Êúâ‰∫ãÊó†Ê≥ïËßÇÁúãÔºåËΩ¨ËÆ©‰∏ÄÂº†„ÄäÂìàÂßÜÈõ∑Áâπ„ÄãÊºîÂá∫Á•®Ôºå‰ΩçÁΩÆÂæàÂ•ΩÔºå‰ª∑Ê†ºÂèØËÆÆ„ÄÇ",
            performanceName = "ÂìàÂßÜÈõ∑Áâπ",
            performanceTime = "2024-12-20 19:30",
            performanceVenue = "ÂõΩÂÆ∂Â§ßÂâßÈô¢",
            price = 380,
            quantity = 1,
            commentCount = 5,
            viewCount = 128
        ),
        TicketPost(
            id = "2",
            type = "purchase",
            userName = "Èü≥‰πêËø∑",
            postTime = "4Â∞èÊó∂Ââç",
            title = "Ê±ÇË¥≠„ÄäÁΩóÂØÜÊ¨ß‰∏éÊú±‰∏ΩÂè∂„ÄãÁ•®",
            description = "ÈùûÂ∏∏ÊÉ≥ÁúãËøôÂú∫ÊºîÂá∫ÔºåÊ±ÇË¥≠‰∏§Âº†ËøûÂ∫ßÁ•®Ôºå‰ª∑Ê†ºÂèØ‰ª•ÂïÜÈáè„ÄÇ",
            performanceName = "ÁΩóÂØÜÊ¨ß‰∏éÊú±‰∏ΩÂè∂",
            performanceTime = "2024-12-25 19:30",
            performanceVenue = "‰∏äÊµ∑Â§ßÂâßÈô¢",
            price = 500,
            quantity = 2,
            commentCount = 3,
            viewCount = 89
        ),
        TicketPost(
            id = "3",
            type = "exchange",
            userName = "ÊàèÂâßËææ‰∫∫",
            postTime = "6Â∞èÊó∂Ââç",
            title = "‰∫§Êç¢„ÄäÊùéÂ∞îÁéã„ÄãÁ•®",
            description = "Êúâ‰∏ÄÂº†12Êúà22Êó•ÁöÑ„ÄäÊùéÂ∞îÁéã„ÄãÁ•®ÔºåÊÉ≥Êç¢12Êúà23Êó•ÁöÑÔºåÊúâÊÑèËÄÖËÅîÁ≥ª„ÄÇ",
            performanceName = "ÊùéÂ∞îÁéã",
            performanceTime = "2024-12-22 19:30",
            performanceVenue = "ÂπøÂ∑ûÂ§ßÂâßÈô¢",
            price = 0,
            quantity = 1,
            commentCount = 8,
            viewCount = 156
        ),
        TicketPost(
            id = "4",
            type = "transfer",
            userName = "Ëâ∫ÊúØÈùíÂπ¥",
            postTime = "8Â∞èÊó∂Ââç",
            title = "ËΩ¨ËÆ©„Ää‰ª≤Â§èÂ§ú‰πãÊ¢¶„ÄãÁ•®",
            description = "ËΩ¨ËÆ©‰∏§Âº†„Ää‰ª≤Â§èÂ§ú‰πãÊ¢¶„ÄãÊºîÂá∫Á•®Ôºå‰ΩçÁΩÆÂú®AÂå∫Ôºå‰ª∑Ê†º‰ºòÊÉ†„ÄÇ",
            performanceName = "‰ª≤Â§èÂ§ú‰πãÊ¢¶",
            performanceTime = "2024-12-28 19:30",
            performanceVenue = "Ê∑±Âú≥Èü≥‰πêÂéÖ",
            price = 280,
            quantity = 2,
            commentCount = 12,
            viewCount = 234
        ),
        TicketPost(
            id = "5",
            type = "purchase",
            userName = "Âè§ÂÖ∏Áà±Â•ΩËÄÖ",
            postTime = "10Â∞èÊó∂Ââç",
            title = "Ê±ÇË¥≠„ÄäÈ∫¶ÂÖãÁôΩ„ÄãÁ•®",
            description = "Ê±ÇË¥≠‰∏ÄÂº†„ÄäÈ∫¶ÂÖãÁôΩ„ÄãÊºîÂá∫Á•®Ôºå‰ªª‰Ωï‰ΩçÁΩÆÈÉΩÂèØ‰ª•Ôºå‰ª∑Ê†ºÂ•ΩËØ¥„ÄÇ",
            performanceName = "È∫¶ÂÖãÁôΩ",
            performanceTime = "2024-12-30 19:30",
            performanceVenue = "Êù≠Â∑ûÂ§ßÂâßÈô¢",
            price = 400,
            quantity = 1,
            commentCount = 6,
            viewCount = 167
        )
    )
    
    return if (filter == "ÂÖ®ÈÉ®") {
        allPosts
    } else {
        allPosts.filter { getTypeText(it.type) == filter }
    }
}
