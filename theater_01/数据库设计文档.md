# 餐剧盒平台数据库设计文档

## 1. 概述

本文档详细描述了餐剧盒平台的数据库设计，包括知识图谱、演出信息、用户互动等各个模块的数据结构设计。

## 2. 数据库架构

### 2.1 技术选型
- **主数据库**: PostgreSQL 14+
- **缓存数据库**: Redis 6+
- **搜索引擎**: Elasticsearch 8+
- **文件存储**: MinIO/AWS S3

### 2.2 数据库命名规范
- 表名: 小写字母，下划线分隔，复数形式
- 字段名: 小写字母，下划线分隔
- 主键: id
- 外键: 表名_id
- 时间字段: created_at, updated_at, deleted_at

## 3. 核心数据表设计

### 3.1 用户相关表

#### 3.1.1 用户表 (users)
```sql
CREATE TABLE users (
    id BIGSERIAL PRIMARY KEY,
    username VARCHAR(50) UNIQUE NOT NULL,
    email VARCHAR(100) UNIQUE NOT NULL,
    phone VARCHAR(20),
    password_hash VARCHAR(255) NOT NULL,
    avatar_url VARCHAR(500),
    nickname VARCHAR(50),
    bio TEXT,
    birth_date DATE,
    gender VARCHAR(10),
    location VARCHAR(100),
    is_verified BOOLEAN DEFAULT FALSE,
    is_actor BOOLEAN DEFAULT FALSE,
    is_disabled BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
```

#### 3.1.2 用户角色表 (user_roles)
```sql
CREATE TABLE user_roles (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    role_name VARCHAR(50) NOT NULL, -- 'admin', 'moderator', 'actor', 'user'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.2 知识图谱相关表

#### 3.2.1 剧目信息表 (plays)
```sql
CREATE TABLE plays (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    original_title VARCHAR(200),
    category VARCHAR(50) NOT NULL, -- 'musical', 'drama', 'comedy', 'opera', 'dance'
    description TEXT,
    plot_summary TEXT,
    author VARCHAR(100),
    director VARCHAR(100),
    composer VARCHAR(100),
    year INTEGER,
    duration_minutes INTEGER,
    language VARCHAR(50),
    rating DECIMAL(3,2) DEFAULT 0.0,
    view_count BIGINT DEFAULT 0,
    tags TEXT[], -- 标签数组
    poster_url VARCHAR(500),
    trailer_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
```

#### 3.2.2 演员信息表 (actors)
```sql
CREATE TABLE actors (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    english_name VARCHAR(100),
    role VARCHAR(50), -- 'lead', 'supporting', 'ensemble', 'understudy'
    description TEXT,
    personal_bio TEXT,
    birth_year INTEGER,
    nationality VARCHAR(50),
    height INTEGER, -- 身高(cm)
    weight INTEGER, -- 体重(kg)
    rating DECIMAL(3,2) DEFAULT 0.0,
    work_count INTEGER DEFAULT 0,
    is_verified BOOLEAN DEFAULT FALSE,
    avatar_url VARCHAR(500),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
```

#### 3.2.3 演员奖项表 (actor_awards)
```sql
CREATE TABLE actor_awards (
    id BIGSERIAL PRIMARY KEY,
    actor_id BIGINT REFERENCES actors(id),
    award_name VARCHAR(200) NOT NULL,
    award_year INTEGER,
    category VARCHAR(100),
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.4 演员专长表 (actor_specialties)
```sql
CREATE TABLE actor_specialties (
    id BIGSERIAL PRIMARY KEY,
    actor_id BIGINT REFERENCES actors(id),
    specialty_name VARCHAR(100) NOT NULL,
    description TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.5 剧场术语表 (terminology)
```sql
CREATE TABLE terminology (
    id BIGSERIAL PRIMARY KEY,
    term VARCHAR(100) NOT NULL,
    category VARCHAR(50) NOT NULL, -- 'performance', 'technical', 'audience', 'business'
    description TEXT NOT NULL,
    detailed_description TEXT,
    usage_examples TEXT[],
    related_terms TEXT[],
    view_count BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.6 角色信息表 (characters)
```sql
CREATE TABLE characters (
    id BIGSERIAL PRIMARY KEY,
    play_id BIGINT REFERENCES plays(id),
    name VARCHAR(100) NOT NULL,
    description TEXT,
    actor_id BIGINT REFERENCES actors(id),
    character_type VARCHAR(50), -- 'protagonist', 'antagonist', 'supporting'
    importance_level INTEGER DEFAULT 1, -- 1-5, 重要性等级
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.7 新闻资讯表 (news)
```sql
CREATE TABLE news (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    content TEXT NOT NULL,
    summary TEXT,
    category VARCHAR(50), -- 'industry', 'performance', 'award', 'announcement'
    author VARCHAR(100),
    source VARCHAR(200),
    cover_image_url VARCHAR(500),
    view_count BIGINT DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    is_published BOOLEAN DEFAULT FALSE,
    published_at TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.2.8 时间线表 (timelines)
```sql
CREATE TABLE timelines (
    id BIGSERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    entity_type VARCHAR(20) NOT NULL, -- 'play', 'actor', 'theater'
    entity_id BIGINT NOT NULL,
    event_date DATE NOT NULL,
    event_type VARCHAR(50), -- 'premiere', 'award', 'performance', 'birth', 'debut'
    event_description TEXT,
    importance_level INTEGER DEFAULT 1, -- 1-5, 重要性等级
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.3 演出信息相关表

#### 3.3.1 剧场表 (theaters)
```sql
CREATE TABLE theaters (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    english_name VARCHAR(200),
    description TEXT,
    address TEXT NOT NULL,
    city VARCHAR(100) NOT NULL,
    province VARCHAR(100) NOT NULL,
    country VARCHAR(100) DEFAULT 'China',
    latitude DECIMAL(10,8),
    longitude DECIMAL(11,8),
    phone VARCHAR(20),
    email VARCHAR(100),
    website VARCHAR(200),
    capacity INTEGER,
    facilities TEXT[],
    parking_info TEXT,
    public_transport TEXT,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.2 演出表 (performances)
```sql
CREATE TABLE performances (
    id BIGSERIAL PRIMARY KEY,
    play_id BIGINT REFERENCES plays(id),
    theater_id BIGINT REFERENCES theaters(id),
    performance_date DATE NOT NULL,
    start_time TIME NOT NULL,
    end_time TIME,
    cast_info JSONB, -- 演员阵容信息
    ticket_price_min DECIMAL(10,2),
    ticket_price_max DECIMAL(10,2),
    available_seats INTEGER,
    total_seats INTEGER,
    status VARCHAR(20) DEFAULT 'scheduled', -- 'scheduled', 'cancelled', 'completed'
    special_notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.3 演出演员表 (performance_actors)
```sql
CREATE TABLE performance_actors (
    id BIGSERIAL PRIMARY KEY,
    performance_id BIGINT REFERENCES performances(id),
    actor_id BIGINT REFERENCES actors(id),
    character_id BIGINT REFERENCES characters(id),
    role_type VARCHAR(50), -- 'lead', 'supporting', 'understudy'
    is_sd BOOLEAN DEFAULT FALSE, -- 是否SD
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.3.4 座位表 (seats)
```sql
CREATE TABLE seats (
    id BIGSERIAL PRIMARY KEY,
    theater_id BIGINT REFERENCES theaters(id),
    section VARCHAR(50) NOT NULL,
    row_number VARCHAR(10) NOT NULL,
    seat_number VARCHAR(10) NOT NULL,
    seat_type VARCHAR(50), -- 'standard', 'vip', 'accessible'
    price_category VARCHAR(50), -- 'A', 'B', 'C'
    is_accessible BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(theater_id, section, row_number, seat_number)
);
```

### 3.4 票务相关表

#### 3.4.1 票务表 (tickets)
```sql
CREATE TABLE tickets (
    id BIGSERIAL PRIMARY KEY,
    performance_id BIGINT REFERENCES performances(id),
    seat_id BIGINT REFERENCES seats(id),
    user_id BIGINT REFERENCES users(id),
    ticket_number VARCHAR(50) UNIQUE NOT NULL,
    price DECIMAL(10,2) NOT NULL,
    discount_amount DECIMAL(10,2) DEFAULT 0,
    final_price DECIMAL(10,2) NOT NULL,
    status VARCHAR(20) DEFAULT 'reserved', -- 'reserved', 'paid', 'cancelled', 'used'
    payment_method VARCHAR(50),
    payment_status VARCHAR(20) DEFAULT 'pending',
    purchase_time TIMESTAMP,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.4.2 盘票表 (ticket_exchanges)
```sql
CREATE TABLE ticket_exchanges (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    performance_id BIGINT REFERENCES performances(id),
    ticket_id BIGINT REFERENCES tickets(id),
    exchange_type VARCHAR(20) NOT NULL, -- 'sell', 'buy', 'exchange'
    original_price DECIMAL(10,2),
    asking_price DECIMAL(10,2),
    description TEXT,
    contact_info JSONB,
    status VARCHAR(20) DEFAULT 'active', -- 'active', 'completed', 'cancelled'
    view_count BIGINT DEFAULT 0,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

### 3.5 内容发布相关表

#### 3.5.1 帖子表 (posts)
```sql
CREATE TABLE posts (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    title VARCHAR(200),
    content TEXT NOT NULL,
    post_type VARCHAR(50) NOT NULL, -- 'review', 'photo', 'video', 'discussion'
    related_play_id BIGINT REFERENCES plays(id),
    related_actor_id BIGINT REFERENCES actors(id),
    related_performance_id BIGINT REFERENCES performances(id),
    tags TEXT[],
    view_count BIGINT DEFAULT 0,
    like_count BIGINT DEFAULT 0,
    comment_count BIGINT DEFAULT 0,
    is_featured BOOLEAN DEFAULT FALSE,
    is_published BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
```

#### 3.5.2 媒体文件表 (media_files)
```sql
CREATE TABLE media_files (
    id BIGSERIAL PRIMARY KEY,
    post_id BIGINT REFERENCES posts(id),
    file_type VARCHAR(20) NOT NULL, -- 'image', 'video', 'audio'
    file_url VARCHAR(500) NOT NULL,
    file_name VARCHAR(200),
    file_size BIGINT,
    duration INTEGER, -- 视频/音频时长(秒)
    thumbnail_url VARCHAR(500),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.5.3 评论表 (comments)
```sql
CREATE TABLE comments (
    id BIGSERIAL PRIMARY KEY,
    post_id BIGINT REFERENCES posts(id),
    user_id BIGINT REFERENCES users(id),
    parent_comment_id BIGINT REFERENCES comments(id),
    content TEXT NOT NULL,
    like_count BIGINT DEFAULT 0,
    is_edited BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    deleted_at TIMESTAMP
);
```

### 3.6 互动社交相关表

#### 3.6.1 点赞表 (likes)
```sql
CREATE TABLE likes (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    target_type VARCHAR(20) NOT NULL, -- 'post', 'comment', 'play', 'actor'
    target_id BIGINT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, target_type, target_id)
);
```

#### 3.6.2 关注表 (follows)
```sql
CREATE TABLE follows (
    id BIGSERIAL PRIMARY KEY,
    follower_id BIGINT REFERENCES users(id),
    following_id BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(follower_id, following_id)
);
```

#### 3.6.3 粉丝社群表 (fan_communities)
```sql
CREATE TABLE fan_communities (
    id BIGSERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,
    description TEXT,
    avatar_url VARCHAR(500),
    cover_image_url VARCHAR(500),
    member_count INTEGER DEFAULT 0,
    is_public BOOLEAN DEFAULT TRUE,
    is_verified BOOLEAN DEFAULT FALSE,
    created_by BIGINT REFERENCES users(id),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.6.4 社群成员表 (community_members)
```sql
CREATE TABLE community_members (
    id BIGSERIAL PRIMARY KEY,
    community_id BIGINT REFERENCES fan_communities(id),
    user_id BIGINT REFERENCES users(id),
    role VARCHAR(20) DEFAULT 'member', -- 'admin', 'moderator', 'member'
    joined_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(community_id, user_id)
);
```

### 3.7 个人化功能相关表

#### 3.7.1 观剧日志表 (viewing_logs)
```sql
CREATE TABLE viewing_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    performance_id BIGINT REFERENCES performances(id),
    play_id BIGINT REFERENCES plays(id),
    viewing_date DATE NOT NULL,
    seat_info VARCHAR(100),
    rating INTEGER CHECK (rating >= 1 AND rating <= 5),
    review TEXT,
    emotions TEXT[], -- 情感标签
    photos TEXT[], -- 照片URL数组
    is_private BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.7.2 AI生成内容表 (ai_generated_content)
```sql
CREATE TABLE ai_generated_content (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    content_type VARCHAR(50) NOT NULL, -- 'character_image', 'actor_photo', 'content_assistant'
    prompt TEXT NOT NULL,
    generated_content_url VARCHAR(500),
    related_play_id BIGINT REFERENCES plays(id),
    related_actor_id BIGINT REFERENCES actors(id),
    status VARCHAR(20) DEFAULT 'processing', -- 'processing', 'completed', 'failed'
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP
);
```

### 3.8 系统配置相关表

#### 3.8.1 系统配置表 (system_configs)
```sql
CREATE TABLE system_configs (
    id BIGSERIAL PRIMARY KEY,
    config_key VARCHAR(100) UNIQUE NOT NULL,
    config_value TEXT,
    description TEXT,
    is_public BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

#### 3.8.2 操作日志表 (operation_logs)
```sql
CREATE TABLE operation_logs (
    id BIGSERIAL PRIMARY KEY,
    user_id BIGINT REFERENCES users(id),
    operation_type VARCHAR(50) NOT NULL,
    target_type VARCHAR(50),
    target_id BIGINT,
    operation_details JSONB,
    ip_address INET,
    user_agent TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## 4. 索引设计

### 4.1 主要索引
```sql
-- 用户表索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_is_actor ON users(is_actor);

-- 剧目表索引
CREATE INDEX idx_plays_category ON plays(category);
CREATE INDEX idx_plays_rating ON plays(rating);
CREATE INDEX idx_plays_year ON plays(year);
CREATE INDEX idx_plays_tags ON plays USING GIN(tags);

-- 演员表索引
CREATE INDEX idx_actors_name ON actors(name);
CREATE INDEX idx_actors_role ON actors(role);
CREATE INDEX idx_actors_rating ON actors(rating);

-- 演出表索引
CREATE INDEX idx_performances_date ON performances(performance_date);
CREATE INDEX idx_performances_play_id ON performances(play_id);
CREATE INDEX idx_performances_theater_id ON performances(theater_id);
CREATE INDEX idx_performances_status ON performances(status);

-- 票务表索引
CREATE INDEX idx_tickets_user_id ON tickets(user_id);
CREATE INDEX idx idx_tickets_performance_id ON tickets(performance_id);
CREATE INDEX idx_tickets_status ON tickets(status);

-- 帖子表索引
CREATE INDEX idx_posts_user_id ON posts(user_id);
CREATE INDEX idx_posts_type ON posts(post_type);
CREATE INDEX idx_posts_created_at ON posts(created_at);
CREATE INDEX idx_posts_tags ON posts USING GIN(tags);

-- 时间线表索引
CREATE INDEX idx_timelines_entity ON timelines(entity_type, entity_id);
CREATE INDEX idx_timelines_date ON timelines(event_date);
```

## 5. 数据关系图

### 5.1 核心实体关系
- **用户** ↔ **剧目** (通过观剧日志、评论、点赞)
- **用户** ↔ **演员** (通过关注、评论、点赞)
- **剧目** ↔ **演员** (通过角色、演出)
- **剧目** ↔ **剧场** (通过演出)
- **演出** ↔ **票务** (通过座位分配)

### 5.2 知识图谱关系
- **剧目** → **角色** → **演员**
- **演员** → **奖项** → **专长**
- **术语** → **相关术语** (自关联)
- **时间线** → **实体** (剧目/演员/剧场)

## 6. 数据存储策略

### 6.1 数据分层
- **热数据**: 用户信息、演出信息、票务信息 (Redis缓存)
- **温数据**: 剧目信息、演员信息、帖子内容 (PostgreSQL)
- **冷数据**: 历史日志、操作记录 (归档存储)

### 6.2 缓存策略
```sql
-- Redis缓存键设计
用户信息: user:{user_id}
剧目信息: play:{play_id}
演员信息: actor:{actor_id}
演出信息: performance:{performance_id}
热门剧目: hot_plays
热门演员: hot_actors
搜索索引: search:{keyword}
```

## 7. 数据安全与备份

### 7.1 数据安全
- 敏感信息加密存储
- 数据库访问权限控制
- 操作日志记录
- 数据脱敏处理

### 7.2 备份策略
- 每日全量备份
- 每小时增量备份
- 异地备份存储
- 定期恢复测试

## 8. 性能优化建议

### 8.1 查询优化
- 使用适当的索引
- 避免N+1查询问题
- 合理使用分页
- 缓存热点数据

### 8.2 存储优化
- 定期清理过期数据
- 压缩历史数据
- 分区大表
- 优化数据类型

## 9. 扩展性考虑

### 9.1 水平扩展
- 读写分离
- 分库分表策略
- 微服务架构
- 负载均衡

### 9.2 功能扩展
- 预留扩展字段
- 版本控制机制
- 插件化架构
- API版本管理

## 10. 监控与维护

### 10.1 性能监控
- 慢查询监控
- 连接数监控
- 存储空间监控
- 响应时间监控

### 10.2 数据质量
- 数据完整性检查
- 数据一致性验证
- 异常数据检测
- 定期数据清理

这个数据库设计文档涵盖了餐剧盒平台的所有核心功能模块，为知识图谱、演出信息、用户互动等提供了完整的数据存储方案。
